# Конспект: Composer — `composer.json` и `composer.lock`

## 1. Что такое Composer?

Composer — менеджер зависимостей для PHP.  
Позволяет:

- подключать сторонние библиотеки;
- управлять версиями зависимостей;
- автоматически загружать классы (autoload).

---

## 2. Файл `composer.json`

### Назначение

Основной конфигурационный файл проекта.  
Хранит:

- имя и описание пакетов;
- зависимости (`require`, `require-dev`);
- настройки автозагрузки;
- скрипты для автоматизации.

### Основные секции

```json
{
  "name": "vendor/package",
  "description": "Краткое описание проекта",
  "type": "project",
  "license": "MIT",
  "require": {
    "php": "^8.1",
    "laravel/framework": "^10.0"
  },
  "require-dev": {
    "phpunit/phpunit": "^10.0"
  },
  "autoload": {
    "psr-4": {
      "App\\": "app/"
    }
  },
  "scripts": {
    "test": "phpunit"
  }
}
```

### Ключевые моменты

Основной конфигурационный файл проекта.

- `require` — обязательные зависимости.
- `require-dev` — пакеты только для разработки.
- `autoload` — правила подключения классов.
- `scripts` — свои команды для composer run-script.
#### Отличие require от require-dev
- **`require`** — зависимости, без которых проект не запустится.  
  (например, фреймворк Laravel).

- **`require-dev`** — зависимости, нужные только при разработке.  
  (например, PHPUnit, Faker).

На продакшн сервере обычно ставят только `require` (через `composer install --no-dev`)

## 3. Файл `composer.lock`

### Назначение

Файл composer.lock сохраняет текущий список установленных зависимостей и их версии. Таким образом, на момент, когда
версии зависимостей уже будут обновлены (команда update), другие люди, которые будут клонировать проект, получат те
же самые версии. Это позволяет убедиться в том, что каждый, кто получает проект, имеет пакетное окружение,
идентичное тому, которое вы использовали при разработке, и помогает избежать ошибок, которые могли бы возникнуть из-за
обновления версий.

При каждом выполнении команды update версии обновлённый пакетов прописываются в composer.lock. Этот файл загоняется под
систему контроля версий и при установке пакетов на новом сервере поставятся именно те версии пакетов, которые прописаны
в этом файле. При выполнении команды install composer будет в первую очередь опираться на composer.lock. Таким образом
на разных серверах будет гарантированно установлено одинаковое пакетное окружение с точки зрения версий.

- `composer.json`: "мне нужна версия ^1.0".
- `composer.lock`: "установлена версия 1.2.3".

Также, файл composer.lock содержит хэш файла composer.json.
И если json файл был отредактирован, то composer выдаст предупреждение, что файл lock не соответствует json файлу.

В таком случае, нужно выполнить команду composer update --lock, которая обновит composer.lock.

## 4. Работа с composer

- Установка зависимостей (по `composer.lock`)
```bash
composer install
```

- Установка зависимостей (по `composer.json`)
```bash
composer update
```

- Добавление новой зависимости:
```bash
composer require vendor/package
```
- Добавление dev-зависимости:
```bash
composer require --dev phpunit/phpunit
```
### Отличие install от update в контексте использования composer.lock

Команда composer install делает следующее:

Проверяет существует ли composer.lock:

— если нет, резолвит зависимости и создаёт его
— если composer.lock существует, устанавливает версии, указанные в нём

Команда composer update:

— Проверяет composer.json
— Определяет последние версии на основе указанных в этом файле
— Устанавливает последние версии
— Обновляет composer.lock в соответствии с установленными

### Для чего нужен `composer dump-autoload`?

Команда обновляет файлы автозагрузки (`vendor/autoload.php`).  
Нужна когда:
- добавили/удалили классы;
- изменили секцию `autoload` в `composer.json`;
- переместили файлы.

Без неё Composer может не найти новые классы. 